<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç®¡ç†å‘˜åå°</title>
    <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: Arial, sans-serif;
          background-color: #f0f2f5;
          color: #333;
      }

      .container {
          display: flex;
          height: 100vh;
      }

      /* Sidebar */
      .sidebar {
          width: 250px;
          background-color: #2f3542;
          color: white;
          padding: 20px;
      }

      .sidebar h2 {
          margin-bottom: 30px;
          text-align: center;
          color: #ff4757;
      }

      .nav-menu {
          list-style: none;
      }

      .nav-menu li {
          margin-bottom: 15px;
      }

      .nav-menu a {
          color: white;
          text-decoration: none;
          display: block;
          padding: 10px;
          border-radius: 4px;
          transition: background-color 0.3s;
      }

      .nav-menu a:hover {
          background-color: #57606f;
      }

      .nav-menu a.active {
          background-color: #ff4757;
      }

      /* Main Content */
      .main-content {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
      }

      /* Header */
      .header {
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          margin-bottom: 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .header h1 {
          color: #333;
      }

      .user-info {
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .btn-logout {
          background-color: #ff4757;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: background-color 0.3s;
      }

      .btn-logout:hover {
          background-color: #ff3742;
      }

      /* Search Section */
      .search-section {
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          margin-bottom: 20px;
      }

      .search-form {
          display: flex;
          gap: 10px;
      }

      .search-input {
          flex: 1;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 16px;
      }

      .search-input:focus {
          outline: none;
          border-color: #ff4757;
          box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.2);
      }

      .btn {
          background-color: #ff4757;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s;
      }

      .btn:hover {
          background-color: #ff3742;
      }

      /* Users Section */
      .users-section {
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .users-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .users-header h2 {
          color: #333;
      }

      /* Users Table */
      .users-table {
          width: 100%;
          border-collapse: collapse;
      }

      .users-table th,
      .users-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
      }

      .users-table th {
          background-color: #f8f9fa;
          font-weight: bold;
          color: #555;
      }

      .users-table tr:hover {
          background-color: #f8f9fa;
      }

      .btn-view {
          background-color: #2ed573;
          color: white;
          border: none;
          padding: 6px 12px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: background-color 0.3s;
      }

      .btn-view:hover {
          background-color: #1e90ff;
      }

      /* User Details Modal */
      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
          background-color: white;
          margin: 5% auto;
          padding: 20px;
          border-radius: 8px;
          width: 80%;
          max-width: 600px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 1px solid #ddd;
      }

      .modal-header h2 {
          color: #333;
      }

      .close {
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }

      .close:hover {
          color: #000;
      }

      .user-details {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
      }

      .detail-item {
          margin-bottom: 15px;
      }

      .detail-label {
          font-weight: bold;
          color: #555;
          margin-bottom: 5px;
      }

      .detail-value {
          color: #333;
      }

      /* Tags */
      .tags {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
          margin-top: 5px;
      }

      .tag {
          background-color: #f0f0f0;
          padding: 3px 8px;
          border-radius: 12px;
          font-size: 12px;
          color: #555;
      }

      /* Avatar */
      .avatar {
          width: 150px;
          height: 150px;
          border-radius: 50%;
          object-cover;
          margin-bottom: 20px;
          border: 4px solid #f0f0f0;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      /* Avatar placeholder */
      .avatar-placeholder {
          width: 150px;
          height: 150px;
          border-radius: 50%;
          background-color: #f0f0f0;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 48px;
          color: #999;
          border: 4px solid #e0e0e0;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Photos */
      .photos {
          display: flex;
          gap: 10px;
          margin-top: 5px;
          flex-wrap: wrap;
      }

      .photo {
          width: 80px;
          height: 80px;
          object-cover;
          border-radius: 4px;
      }

      /* Loading */
      .loading {
          text-align: center;
          padding: 20px;
          color: #555;
      }

      /* Error Message */
      .error-message {
          background-color: #ffebee;
          color: #c62828;
          padding: 10px;
          border-radius: 4px;
          margin-bottom: 20px;
      }

      /* Success Message */
      .success-message {
          background-color: #e8f5e8;
          color: #2e7d32;
          padding: 10px;
          border-radius: 4px;
          margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2>SoulMatch åå°</h2>
        <ul class="nav-menu">
          <li><a href="#" class="active">ç”¨æˆ·ç®¡ç†</a></li>
          <li><a href="#">æ•°æ®ç»Ÿè®¡</a></li>
          <li><a href="#">ç³»ç»Ÿè®¾ç½®</a></li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <h1>ç”¨æˆ·ç®¡ç†</h1>
          <div class="user-info">
            <span id="admin-username"></span>
            <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
          </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
          <form class="search-form" id="search-form">
            <input
              type="text"
              class="search-input"
              id="search-query"
              placeholder="æœç´¢ç”¨æˆ·åã€é‚®ç®±æˆ–ID"
            />
            <button type="submit" class="btn">æœç´¢</button>
          </form>
        </div>

        <!-- Users Section -->
        <div class="users-section">
          <div class="users-header">
            <h2>ç”¨æˆ·åˆ—è¡¨</h2>
            <span id="total-users"></span>
          </div>
          <div
            id="error-message"
            class="error-message"
            style="display: none"
          ></div>
          <div id="loading" class="loading">åŠ è½½ä¸­...</div>
          <table class="users-table" id="users-table" style="display: none">
            <thead>
              <tr>
                <th>å¤´åƒ</th>
                <th>ID</th>
                <th>ç”¨æˆ·å</th>
                <th>å¹´é¾„</th>
                <th>æ€§åˆ«</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="users-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ç”¨æˆ·è¯¦æƒ…</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div id="user-modal-content">
          <!-- User details will be inserted here -->
        </div>
      </div>
    </div>

    <script>
      let currentUsers = [];
      let isSearching = false;

      // Check if user is logged in
      function checkAuth() {
        const token = localStorage.getItem("adminToken");
        const admin = localStorage.getItem("admin");

        if (!token || !admin) {
          window.location.href = "/admin/login.html";
          return false;
        }

        // Set admin username
        const adminData = JSON.parse(admin);
        document.getElementById("admin-username").textContent =
          adminData.username;

        return true;
      }

      // Logout function
      function logout() {
        localStorage.removeItem("adminToken");
        localStorage.removeItem("admin");
        window.location.href = "/admin/login.html";
      }

      // Get all users
      async function getAllUsers() {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch("/api/admin/users", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥");
          }

          const data = await response.json();
          return data;
        } catch (error) {
          throw error;
        }
      }

      // Search users
      async function searchUsers(query) {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(
            `/api/admin/users/search?query=${encodeURIComponent(query)}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("æœç´¢ç”¨æˆ·å¤±è´¥");
          }

          const data = await response.json();
          return data;
        } catch (error) {
          throw error;
        }
      }

      // Get user details
      async function getUserDetails(userId) {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/users/${userId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥");
          }

          const data = await response.json();
          return data;
        } catch (error) {
          throw error;
        }
      }

      // Render users list
      function renderUsers(users) {
        const usersList = document.getElementById("users-list");
        const totalUsers = document.getElementById("total-users");
        const loading = document.getElementById("loading");
        const usersTable = document.getElementById("users-table");

        totalUsers.textContent = `å…± ${users.length} ä¸ªç”¨æˆ·`;

        usersList.innerHTML = "";

        users.forEach((user) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-cover;"></td>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.age}</td>
                    <td>${user.gender}</td>
                    <td>${new Date(user.createdAt).toLocaleString()}</td>
                    <td><button class="btn-view" onclick="viewUser('${
                      user.id
                    }')">æŸ¥çœ‹</button></td>
                `;
          usersList.appendChild(row);
        });

        loading.style.display = "none";
        usersTable.style.display = "table";
      }

      // View user details
      async function viewUser(userId) {
        try {
          const user = await getUserDetails(userId);
          renderUserDetails(user);
          openModal();
        } catch (error) {
          showError(error.message);
        }
      }

      // Render user details
      function renderUserDetails(user) {
        const modalContent = document.getElementById("user-modal-content");

        // Generate avatar HTML with placeholder support
        const avatarHtml = user.avatar ? 
          `<img src="${user.avatar}" alt="Avatar" class="avatar" onerror="this.onerror=null; this.closest('.avatar-container').innerHTML='<div class=\"avatar-placeholder\">ğŸ‘¤</div>'">` : 
          '<div class="avatar-placeholder">ğŸ‘¤</div>';

        modalContent.innerHTML = `
                <!-- Avatar Section -->
                <div class="avatar-container" style="text-align: center; margin-bottom: 30px;">
                    ${avatarHtml}
                    <h3 style="margin: 10px 0; font-size: 24px; color: #333;">${user.name}</h3>
                    <p style="color: #666; margin-bottom: 5px;">${user.age}å² Â· ${user.gender}</p>
                    <p style="color: #999; font-size: 14px;">ID: ${user.id}</p>
                </div>
                
                <!-- Basic Info Section -->
                <div style="margin-bottom: 30px; padding: 20px; background-color: #fafafa; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: #555; font-size: 16px;">åŸºæœ¬ä¿¡æ¯</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="detail-item">
                            <div class="detail-label">é‚®ç®±</div>
                            <div class="detail-value">${user.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">èŒä¸š</div>
                            <div class="detail-value">${user.profession || 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">èº«é«˜</div>
                            <div class="detail-value">${user.height ? `${user.height} cm` : 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ˜Ÿåº§</div>
                            <div class="detail-value">${user.zodiac || 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å®¶ä¹¡</div>
                            <div class="detail-value">${user.hometown || 'æœªå¡«å†™'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Info Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: #555; font-size: 16px;">è¯¦ç»†ä¿¡æ¯</h4>
                    <div class="detail-item" style="margin-bottom: 20px;">
                        <div class="detail-label">è‡ªæˆ‘ä»‹ç»</div>
                        <div class="detail-value" style="white-space: pre-wrap; line-height: 1.5; background-color: #fafafa; padding: 15px; border-radius: 6px;">${user.bio || 'æœªå¡«å†™'}</div>
                    </div>
                    <div class="detail-item" style="margin-bottom: 20px;">
                        <div class="detail-label">äº¤å‹ç›®çš„</div>
                        <div class="detail-value">${user.lookingFor || 'æœªå¡«å†™'}</div>
                    </div>
                    <div class="detail-item" style="margin-bottom: 20px;">
                        <div class="detail-label">æ ‡ç­¾</div>
                        <div class="detail-value">
                            <div class="tags">
                                ${Array.isArray(user.tags) && user.tags.length > 0 ? user.tags
                                  .map(
                                    (tag) =>
                                      `<span class="tag">${tag}</span>`
                                  )
                                  .join("") : 'æ— '}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Photos Section -->
                ${Array.isArray(user.photos) && user.photos.length > 0 ? `
                <div class="detail-item" style="margin-top: 20px;">
                    <div class="detail-label">ç…§ç‰‡</div>
                    <div class="photos" style="margin-top: 10px; gap: 15px;">
                        ${user.photos
                          .map(
                            (photo) =>
                              `<img src="${photo}" alt="Photo" class="photo" style="width: 120px; height: 120px; border-radius: 8px; object-cover; border: 2px solid #f0f0f0; transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='scale(1.05)';" onmouseout="this.style.transform='scale(1)';" onclick="window.open('${photo}', '_blank');">`
                          )
                          .join("")}
                    </div>
                </div>
                ` : ''}
                
                <!-- Account Info Section -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 14px; color: #666;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>æ³¨å†Œæ—¶é—´:</span>
                        <span>${new Date(user.createdAt).toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>æ›´æ–°æ—¶é—´:</span>
                        <span>${new Date(user.updatedAt).toLocaleString()}</span>
                    </div>
                </div>
            `;
      }

      // Open modal
      function openModal() {
        const modal = document.getElementById("user-modal");
        modal.style.display = "block";
      }

      // Close modal
      function closeModal() {
        const modal = document.getElementById("user-modal");
        modal.style.display = "none";
      }

      // Show error message
      function showError(message) {
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      // Hide error message
      function hideError() {
        const errorMessage = document.getElementById("error-message");
        errorMessage.style.display = "none";
      }

      // Load users
      async function loadUsers() {
        hideError();
        document.getElementById("loading").style.display = "block";
        document.getElementById("users-table").style.display = "none";

        try {
          const data = await getAllUsers();
          currentUsers = data.users;
          renderUsers(currentUsers);
        } catch (error) {
          showError(error.message);
          document.getElementById("loading").style.display = "none";
        }
      }

      // Search users
      async function handleSearch(query) {
        hideError();
        document.getElementById("loading").style.display = "block";
        document.getElementById("users-table").style.display = "none";

        try {
          const data = await searchUsers(query);
          renderUsers(data.users);
        } catch (error) {
          showError(error.message);
          document.getElementById("loading").style.display = "none";
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", () => {
        if (checkAuth()) {
          loadUsers();
        }

        // Search form submission
        document
          .getElementById("search-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const query = document.getElementById("search-query").value.trim();
            if (query) {
              handleSearch(query);
              isSearching = true;
            } else {
              loadUsers();
              isSearching = false;
            }
          });

        // Close modal when clicking outside
        window.addEventListener("click", (e) => {
          const modal = document.getElementById("user-modal");
          if (e.target === modal) {
            closeModal();
          }
        });
      });
    </script>
  </body>
</html>
